// File: src/pages/ReadingBook.jsx

import React, { useEffect, useState, useCallback } from "react";
import {
  Button,
  Spinner,
  Modal
} from "react-bootstrap";
import { useNavigate, useParams } from "react-router-dom";
import { useUserSettings } from "../context/UserSettingsContext";
import {
  FiPlay,
  FiPause,
  FiPlus,
  FiSkipBack,
  FiSkipForward
} from "react-icons/fi";

export default function ReadingBook() {
  const [theme, setTheme] = useState(localStorage.getItem("theme") || "light");

  // â€œchaptersâ€ artÄ±k TOC dosyasÄ±nÄ± da kapsayacak (sÄ±fÄ±rÄ±ncÄ± indeks = 00_Table_of_Contents.txt)
  const [chapters, setChapters] = useState([]); 

  // Ä°Ã§erik metni (TOC veya gerÃ§ek bÃ¶lÃ¼m)
  const [selectedContent, setSelectedContent] = useState("");
  const [currentIndex, setCurrentIndex] = useState(0);
  const [loading, setLoading] = useState(false);

  // Analiz kontrolÃ¼ ile ilgili stateâ€™ler
  const [analysisReady, setAnalysisReady] = useState(false);
  const [currentChapterReady, setCurrentChapterReady] = useState(false);
  const [checkingAnalysis, setCheckingAnalysis] = useState(false);

  // Ã–zet ve diÄŸer modal stateâ€™leri (deÄŸiÅŸmedi)
  const [summaryModal, setSummaryModal] = useState(false);
  const [summaryResult, setSummaryResult] = useState("");
  const [summarySelectModal, setSummarySelectModal] = useState(false);
  const [selectedChapterToSummarize, setSelectedChapterToSummarize] = useState("");
  const [isPlaying, setIsPlaying] = useState(false);
  const [playlist, setPlaylist] = useState("general");
  const [showMenu, setShowMenu] = useState(false);
  const [fontSliderValue, setFontSliderValue] = useState(17);
  const [isAdded, setIsAdded] = useState(false);

  // Fade efekti iÃ§in
  const [fadeIn, setFadeIn] = useState(true);

  // LastReadâ€™Ä±n tamamlanÄ±p tamamlanmadÄ±ÄŸÄ±nÄ± takip ederiz
  const [isLastReadFetched, setIsLastReadFetched] = useState(false);

  const navigate = useNavigate();
  const { id } = useParams(); // â€œbookIdâ€ parametre olarak URLâ€™de
  const { settings } = useUserSettings();

  // Tema dinleyicisi (aynÄ± kaldÄ±)
  useEffect(() => {
    const observer = new MutationObserver(() => {
      const newTheme = document.body.dataset.theme || "light";
      setTheme(newTheme);
    });
    observer.observe(document.body, { attributes: true });
    return () => observer.disconnect();
  }, []);

  // --------------------------------------------------------------------------------------------------
  // 1) Kitap aÃ§Ä±ldÄ±ÄŸÄ±nda:
  //    a) /api/chapters/<bookId> â†’ â€œchaptersâ€ dizisi iÃ§ine TOC + bÃ¶lÃ¼mler olarak yerleÅŸecek
  //    b) LocalStorageâ€™dan â€œreadingProgress_<bookId>â€ varsa oradaki indeks doÄŸrudan currentIndexâ€™e ata
  //    c) EÄŸer LocalStorageâ€™de yoksa MongoDBâ€™den LastRead Ã§ekilip, gerÃ§ek bÃ¶lÃ¼m adÄ± â†’ chapters dizisinde karÅŸÄ±laÅŸtÄ±r â†’ index + ata
  //    d) Hepsi tamamlandÄ±ktan sonra isLastReadFetched = true
  //    e) EÄŸer en az 1 gerÃ§ek bÃ¶lÃ¼m varsa (chapters.length > 1) analiz kontrolÃ¼nÃ¼ baÅŸlat
  // --------------------------------------------------------------------------------------------------
  useEffect(() => {
    if (!id) return;

    // 1.a) BÃ¶lÃ¼m dosyalarÄ±nÄ± al (TOC dahil)
    fetch(`http://localhost:5000/api/chapters/${id}`)
      .then((res) => res.json())
      .then((data) => {
        // data[0] her zaman "00_Table_of_Contents.txt" olacaktÄ±r
        setChapters(data);

        // 1.b) LocalStorageâ€™a bakalÄ±m
        const storedIndex = localStorage.getItem(`readingProgress_${id}`);
        if (storedIndex !== null) {
          const idx = parseInt(storedIndex, 10);
          if (!isNaN(idx) && idx >= 0 && idx < data.length) {
            setCurrentIndex(idx);
          }
          setIsLastReadFetched(true);
        } else {
          // 1.c) LocalStorageâ€™da kayÄ±t yoksa MongoDBâ€™den LastRead Ã§ek
          const userId = localStorage.getItem("userId");
          if (userId) {
            fetch(`http://localhost:5000/api/lastread?userId=${userId}&bookId=${id}`)
              .then((res) => res.json())
              .then((lr) => {
                if (lr.chapter) {
                  // lr.chapter gerÃ§ek bÃ¶lÃ¼m dosya adÄ±, Ã¶rn: "02_CHAPTER_II_The_Pool_of_Tears.txt"
                  // chapters dizisinde karÅŸÄ±lÄ±ÄŸÄ± bul
                  const idxInChapters = data.indexOf(lr.chapter);
                  if (idxInChapters >= 0) {
                    setCurrentIndex(idxInChapters);
                  }
                }
                setIsLastReadFetched(true);
              })
              .catch((err) => {
                console.error("LastRead fetch hatasÄ±:", err);
                setIsLastReadFetched(true);
              });
          } else {
            setIsLastReadFetched(true);
          }
        }

        // 1.e) En az 1 gerÃ§ek bÃ¶lÃ¼m varsa (data.length > 1), analiz kontrolÃ¼nÃ¼ baÅŸlat
        //      NOT: data[0] = TOC, gerÃ§ek bÃ¶lÃ¼mler â€œdata.slice(1)â€ iÃ§inde
        if (data.length > 1) {
          const realChapters = data.slice(1);
          pollInitialAnalysis(id, realChapters);
        }
      })
      .catch((err) => {
        console.error("BÃ¶lÃ¼mler alÄ±namadÄ±:", err);
        setIsLastReadFetched(true);
      });
  }, [id]);

  // --------------------------------------------------------------------------------------------------
  // 2) Ä°lk iki gerÃ§ek bÃ¶lÃ¼mÃ¼n (data.slice(1).slice(0,2)) duygu analizi tamamlandÄ±ÄŸÄ±nda analysisReady = true olacak
  //    EÄŸer eksikse her 3 saniyede bir tekrar dene.
  // --------------------------------------------------------------------------------------------------
  const pollInitialAnalysis = async (bookId, realChapters) => {
    setCheckingAnalysis(true);
    try {
      const analysisRes = await fetch(`http://localhost:5000/api/analysis/${bookId}`);
      const analysisFiles = await analysisRes.json();

      // Ä°lk iki gerÃ§ek bÃ¶lÃ¼mÃ¼n emotion dosya adlarÄ±:
      const neededEmotionFiles = realChapters
        .slice(0, 2)
        .map((filename) => filename.replace(".txt", "_emotion.txt"));

      const hasAll = neededEmotionFiles.every((fname) =>
        analysisFiles.includes(fname)
      );

      if (hasAll) {
        setAnalysisReady(true);
        setCheckingAnalysis(false);

        // EÄŸer currentIndex = 0 (TOC) ise, currentChapterReady = true
        // EÄŸer currentIndex = 1 veya 2 (ilk iki gerÃ§ek bÃ¶lÃ¼m) ise, onlarÄ± da hazÄ±r kabul et
        if (currentIndex <= 2) {
          setCurrentChapterReady(true);
        } else {
          // 2+ indeksli gerÃ§ek bÃ¶lÃ¼m varsa, onun kontrolÃ¼nÃ¼ baÅŸlat
          pollChapterAnalysis(bookId, realChapters, currentIndex - 1);
        }
      } else {
        setTimeout(() => pollInitialAnalysis(bookId, realChapters), 3000);
      }
    } catch (err) {
      console.error("Ä°lk analiz kontrol hatasÄ±:", err);
      setTimeout(() => pollInitialAnalysis(bookId, realChapters), 5000);
    }
  };

  // --------------------------------------------------------------------------------------------------
  // 3) Belirli bir gerÃ§ek bÃ¶lÃ¼mÃ¼n duygu analizi var mÄ± diye kontrol eder (index 2 ve sonrasÄ± iÃ§in gerÃ§ek bÃ¶lÃ¼m indeksi = currentIndex-1)
  // --------------------------------------------------------------------------------------------------
  const pollChapterAnalysis = async (bookId, realChapters, realIndex) => {
    try {
      const analysisRes = await fetch(`http://localhost:5000/api/analysis/${bookId}`);
      const analysisFiles = await analysisRes.json();
      const chapterName = realChapters[realIndex];
      const emotionName = chapterName.replace(".txt", "_emotion.txt");

      if (analysisFiles.includes(emotionName)) {
        setCurrentChapterReady(true);
      } else {
        setTimeout(() => pollChapterAnalysis(bookId, realChapters, realIndex), 2000);
      }
    } catch (err) {
      console.error("BÃ¶lÃ¼m analiz kontrol hatasÄ±:", err);
      setTimeout(() => pollChapterAnalysis(bookId, realChapters, realIndex), 5000);
    }
  };

  // --------------------------------------------------------------------------------------------------
  // 4) Bir bÃ¶lÃ¼m seÃ§ildiÄŸinde iÃ§eriÄŸi yÃ¼kle ve â€œcurrentChapterReadyâ€ kontrolÃ¼ yap
  //    - EÄŸer idx === 0 (TOC), anÄ±nda hazÄ±r kabul et
  //    - Aksi halde, idx >= 1 ise gerÃ§ek bÃ¶lÃ¼mler listesindeki dizini hesapla (idx - 1) ve pollChapterAnalysis baÅŸlat
  //    - YÃ¼kleme bittikten sonra fadeIn = true yap
  // --------------------------------------------------------------------------------------------------
  const loadChapter = useCallback(
    (filename) => {
      const idx = chapters.indexOf(filename);
      setCurrentChapterReady(false);

      // Fade efektini baÅŸlat (opacity = 0)
      setFadeIn(false);

      if (idx === 0) {
        // TOC her zaman hazÄ±r
        setCurrentChapterReady(true);
      } else {
        // GerÃ§ek bÃ¶lÃ¼m, gerÃ§ek chapters listesinde gerÃ§ekIndex = idx - 1
        const realIndex = idx - 1;
        pollChapterAnalysis(id, chapters.slice(1), realIndex);
      }

      setLoading(true);
      fetch(`http://localhost:5000/api/chapters/${id}/${filename}`)
        .then((res) => res.json())
        .then((data) => {
          const normalized = data.content.replace(/\n{2,}/g, "\n");
          setSelectedContent(normalized);
          setLoading(false);
          // Ä°Ã§erik yÃ¼klendikten sonra fadeIn = true (opacity = 1)
          setTimeout(() => setFadeIn(true), 50);
        })
        .catch((err) => {
          console.error("BÃ¶lÃ¼m yÃ¼kleme hatasÄ±:", err);
          setLoading(false);
          setTimeout(() => setFadeIn(true), 50);
        });
    },
    [id, chapters]
  );

  // --------------------------------------------------------------------------------------------------
  // 5) currentIndex deÄŸiÅŸtiÄŸinde:
  //    a) isLastReadFetched === false ise bekle (henÃ¼z last read alÄ±nmadÄ±)
  //    b) BÃ¶lÃ¼mÃ¼ yÃ¼kle (loadChapter)
  //    c) LocalStorageâ€™a yeni currentIndexâ€™i kaydet
  //    d) MongoDBâ€™ye LastRead kaydet (isim olarak â€œchapters[currentIndex]â€)
  // --------------------------------------------------------------------------------------------------
  useEffect(() => {
    if (!isLastReadFetched) return;

    if (chapters[currentIndex]) {
      loadChapter(chapters[currentIndex]);
      // LocalStorageâ€™a kaydet
      localStorage.setItem(`readingProgress_${id}`, currentIndex);

      // MongoDBâ€™ye kaydet
      const userId = localStorage.getItem("userId");
      if (userId) {
        fetch("http://localhost:5000/api/lastread/save", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            userId,
            bookId: id,
            chapter: chapters[currentIndex]
          }),
        }).catch((err) => {
          console.error("LastRead save hatasÄ±:", err);
        });
      }
    }
  }, [currentIndex, chapters, loadChapter, id, isLastReadFetched]);

  const isDark = theme === "dark";
  const handleBack = () => navigate("/library");
  const handlePlayPause = () => setIsPlaying((prev) => !prev);

  const handleNext = () => {
    if (currentIndex < chapters.length - 1) {
      setCurrentIndex((prev) => prev + 1);
    }
  };

  const handlePrev = () => {
    if (currentIndex > 0) {
      setCurrentIndex((prev) => prev - 1);
    }
  };

  const requestSummary = async (filename) => {
    setSummaryModal(true);
    setSummaryResult("Summarizing...");
    try {
      const res = await fetch(`http://localhost:5000/api/chapters/${id}/${filename}`);
      const data = await res.json();
      const response = await fetch("http://localhost:8000/summary", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: data.content }),
      });
      const result = await response.json();
      if (result.summary) setSummaryResult(result.summary);
      else setSummaryResult("Summary failed: " + result.error);
    } catch (err) {
      setSummaryResult("Sunucu hatasÄ±: " + err.message);
    }
  };

  // Stil ayarlarÄ±
  const contentBg = isDark ? "#181818" : "#f5f1eb";
  const textColor = isDark ? "#e0e0e0" : "#2c2c2c";
  const headerBg = isDark ? "#1e1e1e" : "#faf9f6";

  // EÄŸer analiz ve mevcut bÃ¶lÃ¼m hazÄ±r deÄŸilse iÃ§eriÄŸi blurâ€™la
  // Not: currentIndex===0 (TOC) â†’ currentChapterReady zaten true ayarlanÄ±yor
  const shouldBlur = !analysisReady || !currentChapterReady;
  const overlayText = !analysisReady ? "Preparing book..." : "Preparing chapter...";

  return (
    <div
      style={{
        display: "flex",
        flexDirection: "column",
        height: "100%",
        backgroundColor: contentBg,
        position: "relative",
      }}
    >
      {/* HEADER */}
      <div
        style={{
          backgroundColor: headerBg,
          color: textColor,
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
          position: "relative",
          height: "50px",
          flexShrink: 0,
        }}
      >
        <Button
          variant="link"
          onClick={handleBack}
          style={{
            position: "absolute",
            left: "10px",
            color: textColor,
            fontSize: "1.5rem",
          }}
        >
          â†
        </Button>
        <span style={{ fontSize: "1.1rem", fontWeight: 500 }}>
          {/*
            â€œchapter numbersâ€ ÅŸu ÅŸekilde gÃ¶zÃ¼kÃ¼yor:
            0 â†’ TOC (erenk â€œChapter 0 / Xâ€ yerine â€œTOC / Xâ€ tarzÄ± yazmak isterseniz burayÄ± dÃ¼zenleyebilirsiniz)
            1 â†’ 1. gerÃ§ek bÃ¶lÃ¼m, vb.
          */}
          {currentIndex === 0
            ? "TOC"
            : `Chapter ${currentIndex} / ${chapters.length - 1}`}
        </span>
        <div style={{ position: "absolute", right: "10px" }}>
          <Button
            variant={isDark ? "outline-light" : "outline-dark"}
            size="sm"
            onClick={() => setShowMenu((prev) => !prev)}
          >
            â˜°
          </Button>
        </div>
      </div>

      {/* MENÃœ PANELÄ° */}
      {showMenu && (
        <div
          style={{
            position: "absolute",
            top: "50px",
            right: "10px",
            width: "220px",
            backgroundColor: isDark ? "#2c2c2c" : "#fff",
            color: isDark ? "#fff" : "#000",
            border: "1px solid #ccc",
            borderRadius: "0.5rem",
            zIndex: 2000,
            padding: "1rem",
            boxShadow: "0 4px 10px rgba(0,0,0,0.2)",
          }}
        >
          <div className="d-flex flex-column gap-3">
            <Button
              size="sm"
              variant={isDark ? "outline-light" : "outline-dark"}
              onClick={() => {
                setShowMenu(false);
                setSummarySelectModal(true);
              }}
            >
              ğŸ“„ Summary
            </Button>
            <div>
              <div className="mb-1">Font Size</div>
              <input
                type="range"
                min={12}
                max={28}
                step={1}
                value={fontSliderValue}
                onChange={(e) => setFontSliderValue(parseInt(e.target.value, 10))}
                className="form-range"
              />
              <div style={{ fontSize: "0.8rem" }}>Current: {fontSliderValue}px</div>
            </div>
            <div>
              <div>ğŸ–¼ Image Preference</div>
              <small>(Not implemented yet)</small>
            </div>
            <Button
              size="sm"
              variant={isDark ? "outline-light" : "outline-dark"}
              onClick={() => {
                localStorage.setItem(`readingProgress_${id}`, currentIndex);
                alert("Progress saved âœ…");
              }}
            >
              ğŸ’¾ Save Progress
            </Button>
          </div>
        </div>
      )}

      {/* Ä°Ã‡ERÄ°K ALANI */}
      <div
        style={{
          height: "calc(100% - 50px - 50px)",
          overflowY: "auto",
          padding: "1rem",
          backgroundColor: contentBg,
          color: textColor,
          filter: shouldBlur ? "blur(5px)" : "none",
          transition: "filter 0.3s ease-in-out"
        }}
        className="custom-scroll"
      >
        {loading ? (
          <div
            className="d-flex justify-content-center align-items-center"
            style={{ height: "100%" }}
          >
            <Spinner animation="border" />
          </div>
        ) : (
          <pre
            style={{
              whiteSpace: "pre-wrap",
              fontFamily: settings.fontFamily || "Georgia, serif",
              fontSize: `${fontSliderValue}px`,
              lineHeight: settings.lineHeight || 1.8,
              maxWidth: "900px",
              margin: "0 auto",
              opacity: fadeIn ? 1 : 0,
              transition: "opacity 0.3s ease-in-out",
            }}
          >
            {selectedContent}
          </pre>
        )}

        {/* EÄŸer analiz ve currentChapterReady tamamsa, Prev/Next butonlarÄ±nÄ± gÃ¶ster */}
        {!shouldBlur && (
          <>
            {/*
              â€œPrevâ€ TUÅU:
              - EÄŸer currentIndex > 0 ise gÃ¶ster (â€œ0â€ TOC ise de geri dÃ¶nmeye izin verebiliriz)
            */}
            {currentIndex > 0 && (
              <Button
                onClick={handlePrev}
                style={{
                  position: "fixed",
                  left: "10px",
                  top: "50%",
                  transform: "translateY(-50%)",
                  borderRadius: "50%",
                  width: "44px",
                  height: "44px",
                  backgroundColor: "#444",
                  color: "#fff",
                  zIndex: 1000,
                  border: "none",
                }}
              >
                <FiSkipBack size={24} />
              </Button>
            )}

            {/*
              â€œNextâ€ TUÅU:
              - EÄŸer currentIndex < chapters.length - 1 ise gÃ¶ster
            */}
            {currentIndex < chapters.length - 1 && (
              <Button
                onClick={handleNext}
                style={{
                  position: "fixed",
                  right: "10px",
                  top: "50%",
                  transform: "translateY(-50%)",
                  borderRadius: "50%",
                  width: "44px",
                  height: "44px",
                  backgroundColor: "#444",
                  color: "#fff",
                  zIndex: 1000,
                  border: "none",
                }}
              >
                <FiSkipForward size={24} />
              </Button>
            )}
          </>
        )}
      </div>

      {/* Overlay: â€œPreparing book / chapterâ€¦â€ */}
      {shouldBlur && (
        <div
          style={{
            position: "absolute",
            top: "50px",
            left: 0,
            right: 0,
            bottom: "50px",
            display: "flex",
            flexDirection: "column",
            alignItems: "center",
            justifyContent: "center",
            backgroundColor: isDark
              ? "rgba(0, 0, 0, 0.6)"
              : "rgba(255, 255, 255, 0.8)",
            color: isDark ? "#fff" : "#000",
            zIndex: 1500,
          }}
        >
          {checkingAnalysis && (
            <Spinner animation="border" variant={isDark ? "light" : "dark"} />
          )}
          <div style={{ marginTop: checkingAnalysis ? "0.5rem" : 0, fontSize: "1.2rem" }}>
            {overlayText}
          </div>
        </div>
      )}

      {/* MÃœZÄ°K BARI (Ã–rnek Sabit TasarÄ±m) */}
      <div
        className="position-fixed bottom-0 start-0 end-0 d-flex justify-content-between align-items-center px-3"
        style={{
          height: "50px",
          backgroundColor: "#000",
          color: "#fff",
          zIndex: 1200,
        }}
      >
        <div className="d-flex align-items-center gap-2">
          <img
            src="https://picsum.photos/200/200?random=31"
            alt="cover"
            style={{
              width: "40px",
              height: "40px",
              borderRadius: "0.5rem",
              objectFit: "cover",
            }}
          />
          <div>
            <div style={{ fontWeight: "bold", fontSize: "0.9rem" }}>
              Locked Eyes
            </div>
            <div style={{ fontSize: "0.7rem", color: "#ccc" }}>
              Mystery Friends
            </div>
          </div>
        </div>

        <div className="d-flex align-items-center gap-2">
          <Button
            variant="outline-light"
            size="sm"
            style={{
              borderRadius: "50%",
              width: "30px",
              height: "30px",
              padding: 0,
            }}
          >
            <FiSkipBack size={16} />
          </Button>
          <Button
            variant="light"
            size="sm"
            onClick={handlePlayPause}
            style={{
              borderRadius: "50%",
              width: "36px",
              height: "36px",
              padding: 0,
            }}
          >
            {isPlaying ? <FiPause size={18} /> : <FiPlay size={18} />}
          </Button>
          <Button
            variant="outline-light"
            size="sm"
            style={{
              borderRadius: "50%",
              width: "30px",
              height: "30px",
              padding: 0,
            }}
          >
            <FiSkipForward size={16} />
          </Button>
        </div>

        <div className="d-flex align-items-center gap-2">
          <select
            className="form-select form-select-sm"
            value={playlist}
            onChange={(e) => setPlaylist(e.target.value)}
            style={{
              maxWidth: "120px",
              backgroundColor: "#1f1f1f",
              color: "#fff",
              borderColor: "#333",
              borderRadius: "0.375rem",
              height: "30px",
              fontSize: "0.8rem",
            }}
          >
            <option value="general">ğŸµ General</option>
            <option value="my">ğŸ¶ My Playlist</option>
          </select>
          <Button
            variant="outline-light"
            size="sm"
            onClick={() => setIsAdded(true)}
            disabled={isAdded}
            style={{
              height: "30px",
              width: "50px",
              borderRadius: "0.375rem",
              fontSize: "0.75rem",
              padding: 0,
            }}
          >
            <FiPlus size={16} />
          </Button>
        </div>
      </div>

      {/* Ã–ZET SEÃ‡Ä°M MODAL */}
      <Modal
        show={summarySelectModal}
        onHide={() => setSummarySelectModal(false)}
        centered
      >
        <Modal.Header closeButton>
          <Modal.Title>Which chapter would you like to summarize?</Modal.Title>
        </Modal.Header>
        <Modal.Body>
          <select
            value={selectedChapterToSummarize}
            onChange={(e) => setSelectedChapterToSummarize(e.target.value)}
            className="form-select mb-3"
          >
            <option value="">Select a Chapter</option>
            {/*
              TOC de listede gÃ¶rÃ¼nsÃ¼n, isterseniz TOCâ€™yi summary iÃ§in engellersiniz.
              Burada sadece gerÃ§ek bÃ¶lÃ¼mleri gÃ¶stermek isterseniz:
              chapters.slice(1).map(...) ile deÄŸiÅŸtirin.
            */}
            {chapters.map((ch, idx) => (
              <option key={idx} value={ch}>
                {ch.replace(".txt", "").replace(/_/g, " ")}
              </option>
            ))}
          </select>
          <Button
            onClick={() => {
              if (selectedChapterToSummarize) {
                setSummarySelectModal(false);
                requestSummary(selectedChapterToSummarize);
              }
            }}
            disabled={!selectedChapterToSummarize}
          >
            Summarize
          </Button>
        </Modal.Body>
      </Modal>

      {/* Ã–ZET SONUÃ‡ MODAL */}
      <Modal show={summaryModal} onHide={() => setSummaryModal(false)} centered size="lg">
        <Modal.Header closeButton>
          <Modal.Title>Chapter Summary</Modal.Title>
        </Modal.Header>
        <Modal.Body
          style={{
            whiteSpace: "pre-wrap",
            fontFamily: settings.fontFamily || "Georgia, serif",
          }}
        >
          {summaryResult}
        </Modal.Body>
      </Modal>

      {/* Scrollbar stili */}
      <style>{`
        .custom-scroll::-webkit-scrollbar {
          width: 8px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
          background-color: ${isDark ? "#444" : "#bbb"};
          border-radius: 4px;
        }
        .custom-scroll::-webkit-scrollbar-track {
          background-color: ${isDark ? "#2b2b2b" : "#eee"};
        }
      `}</style>
    </div>
  );
}
